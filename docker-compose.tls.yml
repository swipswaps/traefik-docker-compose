version: "3.7"

services:
  traefik:
    command:
      - "--certificatesResolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme/acme.json"
      - "--certificatesResolvers.letsencrypt.acme.tlsChallenge=true"
      - "--certificatesResolvers.letsencrypt.acme.dnsChallenge=true"
      - "--certificatesResolvers.letsencrypt.acme.dnsChallenge.provider=digitalocean"
    environment:
      - "DO_AUTH_TOKEN=${DO_AUTH_TOKEN}"
    volumes:
      - type: volume
        source: letsencrypt
        target: "/etc/traefik/acme/"
    deploy:
      labels:
        - "traefik.http.routers.traefik.tls=true"
        - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
        - "traefik.http.routers.traefik.tls.domains[0].main=${DOMAIN}"
        - "traefik.http.routers.traefik.tls.domains[0].sans=*.${DOMAIN}"
volumes:
  letsencrypt: